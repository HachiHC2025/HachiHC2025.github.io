<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šè¯­ç§å³æ—¶ç¿»è¯‘å™¨ï¼ˆå¸¦è¯­éŸ³åŠŸèƒ½ï¼‰</title>
    <style>
        :root {
            --primary-color: #8a2be2;
            --secondary-color: #6a0dad;
            --light-purple: #d4a5ff;
            --bg-color: #f9f4ff;
            --text-dark: #333;
            --text-light: #666;
            --white: #fff;
            --disabled: #ccc;
            --box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        body { 
            font-family: 'Arial', 'Microsoft YaHei', sans-serif; 
            text-align: center; 
            margin: 50px auto 0;
            background: var(--bg-color);
            line-height: 1.6;
            color: var(--text-dark);
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        textarea { 
            width: 90%; 
            min-height: 120px; 
            padding: 15px; 
            font-size: 16px;
            border: 2px solid var(--light-purple); 
            border-radius: 12px;
            resize: vertical;
            transition: border 0.3s, box-shadow 0.3s;
        }
        
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.2);
        }
        
        .output-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }
        
        .output-box {
            padding: 20px;
            background: var(--white);
            border-radius: 10px; 
            box-shadow: var(--box-shadow);
            text-align: left;
            position: relative;
            transition: transform 0.3s;
        }
        
        .output-box:hover {
            transform: translateY(-3px);
        }
        
        h1, h2 { 
            color: var(--primary-color); 
            margin-bottom: 25px;
        }
        
        .language-label {
            font-weight: bold;
            color: var(--secondary-color);
            margin-bottom: 12px;
            display: block;
            font-size: 1.1em;
        }
        
        .translation-result {
            min-height: 20px;
            word-break: break-word;
        }
        
        .speak-btn {
            position: absolute;
            right: 15px;
            top: 15px;
            background: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .speak-btn:hover {
            background: var(--secondary-color);
            transform: scale(1.1);
        }
        
        .speak-btn:disabled {
            background: var(--disabled);
            cursor: not-allowed;
            transform: none;
        }
        
        .loading-indicator {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(138, 43, 226, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 600px) {
            body {
                margin-top: 30px;
            }
            
            .container {
                padding: 15px;
            }
            
            textarea {
                width: 100%;
            }
            
            .output-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ¸ ä¸­æ–‡ â†’ å››è¯­åŒæ­¥ç¿»è¯‘å™¨ï¼ˆå¸¦è¯­éŸ³åŠŸèƒ½ï¼‰ğŸŒ¸</h1>
        <textarea id="inputText" placeholder="åœ¨è¿™é‡Œè¾“å…¥ä¸­æ–‡...æ¯”å¦‚ã€Œä»Šå¤©å¤©æ°”çœŸå¥½ï¼ã€" aria-label="è¾“å…¥ä¸­æ–‡æ–‡æœ¬"></textarea>
        
        <div class="output-container" id="output">
            <!-- ç¿»è¯‘ç»“æœå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <script>
        // é˜²æŠ–å‡½æ•°ï¼Œå‡å°‘APIè°ƒç”¨é¢‘ç‡
        function debounce(func, delay) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }
        
        // è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦ï¼Œé˜²æ­¢XSSæ”»å‡»
        function escapeHtml(unsafe) {
            return unsafe.replace(/[&<>"']/g, function(match) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[match];
            });
        }
        
        // è¯­è¨€é…ç½®
        const LANGUAGES = Object.freeze([
            { code: 'en', name: 'è‹±è¯­', voiceLang: 'en-US' },
            { code: 'ja', name: 'æ—¥è¯­', voiceLang: 'ja-JP' },
            { code: 'fr', name: 'æ³•è¯­', voiceLang: 'fr-FR' },
            { code: 'ko', name: 'éŸ©è¯­', voiceLang: 'ko-KR' }
        ]);
        
        // DOMå…ƒç´ ç¼“å­˜
        const elements = {
            inputText: document.getElementById('inputText'),
            output: document.getElementById('output')
        };
        
        // åˆå§‹åŒ–å‡½æ•°
        function init() {
            // æ·»åŠ é˜²æŠ–è¾“å…¥ç›‘å¬
            elements.inputText.addEventListener('input', debounce(handleInput, 500));
            
            // æ£€æŸ¥è¯­éŸ³åˆæˆæ”¯æŒ
            if (!window.speechSynthesis) {
                console.warn('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆAPI');
            }
        }
        
        // å¤„ç†è¾“å…¥
        async function handleInput(e) {
            const text = e.target.value.trim();
            
            if (!text) {
                elements.output.innerHTML = '';
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            renderLoadingState();
            
            try {
                // å¹¶è¡Œè·å–æ‰€æœ‰ç¿»è¯‘
                const translations = await Promise.allSettled(
                    LANGUAGES.map(lang => fetchTranslation(text, lang))
                );
                
                // æ¸²æŸ“ç»“æœ
                renderTranslations(translations);
            } catch (error) {
                console.error('ç¿»è¯‘å‡ºé”™:', error);
                renderErrorState();
            }
        }
        
        // è·å–ç¿»è¯‘
        async function fetchTranslation(text, lang) {
            try {
                const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=zh-CN|${lang.code}`);
                
                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                }
                
                const data = await response.json();
                return {
                    ...lang,
                    translatedText: data.responseData?.translatedText || 'ï¼ˆç¿»è¯‘å¤±è´¥ï¼‰'
                };
            } catch (error) {
                console.error(`${lang.name}ç¿»è¯‘å‡ºé”™:`, error);
                return {
                    ...lang,
                    translatedText: 'ğŸ†˜ ç¿»è¯‘æœåŠ¡æš‚æ—¶ä¸å¯ç”¨'
                };
            }
        }
        
        // æ¸²æŸ“åŠ è½½çŠ¶æ€
        function renderLoadingState() {
            elements.output.innerHTML = LANGUAGES.map(lang => `
                <div class="output-box">
                    <button class="speak-btn" disabled>
                        ğŸ”Š
                    </button>
                    <span class="language-label">${lang.name}ï¼š</span>
                    <div class="translation-result">
                        <span class="loading-indicator"></span>ç¿»è¯‘ä¸­...
                    </div>
                </div>
            `).join('');
        }
        
        // æ¸²æŸ“ç¿»è¯‘ç»“æœ
        function renderTranslations(translations) {
            elements.output.innerHTML = translations.map(result => {
                const { name, translatedText, voiceLang } = result.value || {};
                const isSuccess = result.status === 'fulfilled' && 
                                translatedText && 
                                translatedText !== 'ï¼ˆç¿»è¯‘å¤±è´¥ï¼‰';
                
                return `
                    <div class="output-box">
                        <button class="speak-btn" 
                                onclick="speakText('${escapeHtml(translatedText)}', '${voiceLang}')" 
                                title="æœ—è¯»ç¿»è¯‘" 
                                ${!isSuccess ? 'disabled' : ''}>
                            ğŸ”Š
                        </button>
                        <span class="language-label">${name}ï¼š</span>
                        <div class="translation-result">
                            ${translatedText || 'ç¿»è¯‘å¤±è´¥'}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // æ¸²æŸ“é”™è¯¯çŠ¶æ€
        function renderErrorState() {
            elements.output.innerHTML = `
                <div class="output-box" style="grid-column: 1/-1">
                    <div class="translation-result" style="color: red;">
                        âš ï¸ ç¿»è¯‘æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•
                    </div>
                </div>
            `;
        }
        
        // è¯­éŸ³åˆæˆå‡½æ•°
        function speakText(text, lang) {
            if (!text || text.includes('ï¼ˆç¿»è¯‘å¤±è´¥ï¼‰') || text.includes('ä¸å¯ç”¨')) return;
            
            if (!window.speechSynthesis) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆåŠŸèƒ½ï¼Œè¯·ä½¿ç”¨Chromeã€Edgeæˆ–Firefoxç­‰ç°ä»£æµè§ˆå™¨ã€‚');
                return;
            }
            
            // åœæ­¢å½“å‰è¯­éŸ³
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance();
            utterance.text = text;
            utterance.lang = lang;
            utterance.rate = 0.9;
            utterance.volume = 1;
            utterance.pitch = 1;
            
            // æŸ¥æ‰¾åˆé€‚çš„è¯­éŸ³
            const voices = window.speechSynthesis.getVoices();
            const preferredVoice = voices.find(v => v.lang === lang) || 
                                 voices.find(v => v.lang.startsWith(lang.split('-')[0]));
            
            if (preferredVoice) {
                utterance.voice = preferredVoice;
            }
            
            utterance.onerror = (event) => {
                console.error('è¯­éŸ³åˆæˆé”™è¯¯:', event);
                alert('æœ—è¯»æ—¶å‡ºé”™: ' + event.error);
            };
            
            window.speechSynthesis.speak(utterance);
        }
        
        // åˆå§‹åŒ–è¯­éŸ³åˆæˆAPI
        if (window.speechSynthesis) {
            window.speechSynthesis.onvoiceschanged = () => {
                console.log('è¯­éŸ³åˆ—è¡¨å·²åŠ è½½');
            };
        }
        
        // å¯åŠ¨åº”ç”¨
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
